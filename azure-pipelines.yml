trigger:
  branches:
    include:
      - uat

variables:
  azureServiceConnection: 'lupinglobal-sc'
  uatWebAppName: 'lupin-uat'
  nodeVersion: '20.x'

stages:

# =========================
# BUILD STAGE
# =========================
- stage: Build
  displayName: Build Next.js Frontend
  jobs:
    - job: BuildJob
      pool:
        vmImage: ubuntu-latest

      steps:
        - task: NodeTool@0
          displayName: Use Node.js $(nodeVersion)
          inputs:
            versionSpec: '$(nodeVersion)'

        - script: |
            export SKIP_STRAPI_FETCH=true
            npm ci
            npm run build
          displayName: Install & Build Next.js

        # Prepare standalone bundle
        - script: |
            set -e

            echo "Preparing standalone bundle..."
            mkdir -p .next/standalone/.next
            mkdir -p .next/standalone/.next/cache

            cp -r .next/static .next/standalone/.next/static
            cp -r public .next/standalone/public

            echo "Standalone content:"
            ls -la .next/standalone
          displayName: Prepare standalone bundle

        - task: ArchiveFiles@2
          displayName: Archive standalone output
          inputs:
            rootFolderOrFile: '.next/standalone'
            includeRootFolder: false
            archiveType: zip
            archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
            replaceExistingArchive: true

        - task: PublishBuildArtifacts@1
          displayName: Publish Artifact
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)/frontend.zip'
            ArtifactName: drop

# =========================
# DEPLOY STAGE
# =========================
- stage: Deploy_UAT
  displayName: Deploy to UAT
  dependsOn: Build
  condition: succeeded()

  jobs:
    - deployment: DeployUAT
      displayName: Deploy Frontend to UAT
      environment: uat
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: drop

              - task: AzureWebApp@1
                displayName: Deploy to Azure Web App
                inputs:
                  azureSubscription: '$(azureServiceConnection)'
                  appType: webAppLinux
                  appName: '$(uatWebAppName)'
                  package: '$(Pipeline.Workspace)/drop/frontend.zip'
                  startUpCommand: 'node server.js'
