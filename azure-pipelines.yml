trigger:
  branches:
    include:
      - uat

variables:
  azureServiceConnection: 'lupinglobal-sc'
  uatWebAppName: 'lupin-uat'
  nodeVersion: '20.x'

stages:

################################
#        BUILD STAGE
################################
- stage: Build
  displayName: "Build Lupin Frontend"
  jobs:
    - job: BuildJob
      pool:
        vmImage: 'ubuntu-latest'

      steps:

        # Use Node
        - task: NodeTool@0
          displayName: "Use Node.js $(nodeVersion)"
          inputs:
            versionSpec: '$(nodeVersion)'

        # CodeQL Init
        - task: AdvancedSecurity-Codeql-Init@1
          displayName: "Initialize CodeQL"
          inputs:
            languages: 'javascript'
            querysuite: 'security-and-quality'

        # Install & Build
        - script: |
            npm ci
            npm run build
          displayName: "Install dependencies & build Next.js"

        # CodeQL Analyze
        - task: AdvancedSecurity-Codeql-Analyze@1
          displayName: "Run CodeQL Analysis"

        # -----------------------------
        # CREATE STANDALONE BUNDLE
        # -----------------------------
        - script: |
            set -e

            echo "Preparing standalone bundle..."
            mkdir -p .next/standalone/.next
            mkdir -p .next/standalone/.next/cache

            if [ -d ".next/static" ]; then
              cp -r .next/static .next/standalone/.next/static
            fi

            if [ -d "public" ]; then
              cp -r public .next/standalone/public
            fi

            echo "Standalone bundle ready"
            ls -la .next/standalone
          displayName: "Assemble standalone bundle"

        # ZIP ONLY STANDALONE
        - task: ArchiveFiles@2
          displayName: "Archive standalone output"
          inputs:
            rootFolderOrFile: "$(System.DefaultWorkingDirectory)/.next/standalone"
            includeRootFolder: false
            archiveType: zip
            archiveFile: "$(Build.ArtifactStagingDirectory)/frontend.zip"
            replaceExistingArchive: true

        # Publish Artifact
        - task: PublishBuildArtifacts@1
          displayName: "Publish Build Artifact"
          inputs:
            PathtoPublish: "$(Build.ArtifactStagingDirectory)"
            ArtifactName: drop
            publishLocation: Container


################################
#        DEPLOY STAGE
################################
- stage: Deploy_UAT
  displayName: "Deploy to UAT"
  dependsOn: Build
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/uat')

  jobs:
    - deployment: DeployUAT
      displayName: "Deploy to Azure Web App"
      environment: uat
      strategy:
        runOnce:
          deploy:
            steps:
              - download: current
                artifact: drop

              - task: AzureWebApp@1
                displayName: "Deploy Lupin Frontend to UAT"
                inputs:
                  azureSubscription: "$(azureServiceConnection)"
                  appType: webAppLinux
                  appName: "$(uatWebAppName)"
                  package: "$(Pipeline.Workspace)/drop/frontend.zip"
                  startUpCommand: "node server.js"
